---
layout: post
title:  "Something About AngularJS"
date:   2015-05-18 22:29:47
categories: jekyll update
---


##A recode for refactoring promise
<strong>Question:</strong>the second refactoring right?
###This original code:
            Hotel.findById(_id).then(function(obj){
                 
                    actionDetail = 'Assign from ['+obj.email+'] to ['+req.session.email+']';
                
                    if(obj)obj.update({occupy:req.session.email})
                        .then(function(obj){
                    
                            operation = {operator:req.session.email,action:actionDetail,desc:"",time:new Date()};

                            Operation.create(operation).then(function(o){
                                obj.addOperation(o);
                            });
                    });
                    else
                        res.send('{"code":"401","error":"'+e+'"}');
            });
###The code refactored:
            var foundHotel=null;
            Hotel.findById(_id).then(function(obj){
                actionDetail = 'Assign from ['+obj.email+'] to ['+req.session.email+']';   
                if(obj)
                {
                    foundHotel = obj;
                    return obj.update({occupy:req.session.email});
                }
                throw new Error('hotel not found');  
 
            }).then(function(obj){
                    res.send(obj);
                    operation = {operator:req.session.email,action:actionDetail,desc:"",time:new Date()};
                    return Operation.create(operation);
            }).then(function(obj){
                foundHotel.addOperation(obj);
            }).catch(function(e){
                res.send('{"code":"401","error":"'+e+'"}');
            });       
         

